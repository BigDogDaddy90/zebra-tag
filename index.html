<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZEBRA TAG - DIAGNOSTIC</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <style>
        :root {
            --green:   #00ff41;
            --green-dim: #00a828;
            --bg:      #050505;
            --surface: #0d0d0d;
            --border:  #1c1c1c;
            --red:     #ff3c3c;
            --amber:   #ffaa00;
            --gray:    #444;
            --text:    #e0e0e0;
            --mono:    'Share Tech Mono', monospace;
            --display: 'Barlow Condensed', sans-serif;
        }

```
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
        background: var(--bg);
        color: var(--text);
        font-family: var(--mono);
        min-height: 100vh;
        padding: 20px;
    }

    .diagnostic-header {
        font-family: var(--display);
        font-size: 1.5rem;
        color: var(--green);
        margin-bottom: 20px;
        text-align: center;
        letter-spacing: 4px;
    }

    .test-section {
        background: var(--surface);
        border: 1px solid var(--border);
        padding: 20px;
        margin-bottom: 20px;
    }

    .test-title {
        font-family: var(--display);
        font-size: 1rem;
        color: var(--green);
        margin-bottom: 10px;
        letter-spacing: 2px;
    }

    .scanner-input {
        width: 100%;
        background: #000;
        border: 2px solid var(--green);
        color: var(--green);
        font-family: var(--mono);
        font-size: 1rem;
        padding: 15px;
        margin-bottom: 10px;
    }

    .log-box {
        background: #000;
        border: 1px solid var(--border);
        color: var(--green);
        font-size: 0.75rem;
        padding: 15px;
        max-height: 300px;
        overflow-y: auto;
        font-family: var(--mono);
        line-height: 1.6;
    }

    .log-entry {
        margin-bottom: 5px;
    }

    .log-entry.error { color: var(--red); }
    .log-entry.success { color: var(--green); }
    .log-entry.info { color: var(--amber); }

    .btn {
        width: 100%;
        padding: 15px;
        font-family: var(--display);
        font-size: 1rem;
        font-weight: 900;
        letter-spacing: 3px;
        background: var(--green);
        color: #000;
        border: none;
        cursor: pointer;
        margin-top: 10px;
    }

    .status-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
    }

    .status-item {
        background: #000;
        padding: 10px;
        border-left: 3px solid var(--border);
    }

    .status-item.active {
        border-left-color: var(--green);
    }

    .status-label {
        font-size: 0.6rem;
        color: var(--gray);
        letter-spacing: 2px;
        margin-bottom: 5px;
    }

    .status-value {
        font-size: 1rem;
        color: var(--text);
    }

    .manual-test {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }

    .manual-test input {
        flex: 1;
        background: #000;
        border: 1px solid var(--border);
        color: var(--green);
        font-family: var(--mono);
        padding: 10px;
    }

    .manual-test button {
        padding: 10px 20px;
        background: var(--green-dim);
        border: none;
        color: #000;
        font-family: var(--display);
        cursor: pointer;
    }
</style>
```

</head>
<body>

<div class="diagnostic-header">SCANNER DIAGNOSTIC MODE</div>

<div class="test-section">
    <div class="test-title">SYSTEM STATUS</div>
    <div class="status-grid">
        <div class="status-item" id="auth-status">
            <div class="status-label">AUTHENTICATION</div>
            <div class="status-value">CHECKING...</div>
        </div>
        <div class="status-item" id="firebase-status">
            <div class="status-label">FIREBASE</div>
            <div class="status-value">CONNECTING...</div>
        </div>
        <div class="status-item" id="focus-status">
            <div class="status-label">INPUT FOCUS</div>
            <div class="status-value">UNKNOWN</div>
        </div>
        <div class="status-item" id="scan-status">
            <div class="status-label">LAST SCAN</div>
            <div class="status-value">NONE</div>
        </div>
    </div>
</div>

<div class="test-section">
    <div class="test-title">SCANNER INPUT (VISIBLE FOR TESTING)</div>
    <input type="text" id="scanner" class="scanner-input" 
           placeholder="Scanner input appears here..." 
           autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">

```
<div class="manual-test">
    <input type="text" id="manual-input" placeholder="Type 'SHP MD01' or 'SHP RR01' to test">
    <button onclick="manualTest()">TEST</button>
</div>
```

</div>

<div class="test-section">
    <div class="test-title">EVENT LOG</div>
    <div id="log-box" class="log-box">
        <div class="log-entry info">System initialized. Waiting for scanner input...</div>
    </div>
    <button class="btn" onclick="clearLog()">CLEAR LOG</button>
</div>

<script>
// ─────────────────────────────────────────────────────────────────────────────
// CONFIG
// ─────────────────────────────────────────────────────────────────────────────
const FIREBASE_CONFIG = {
    apiKey: "AIzaSyDFIuHkzGlTNn20-2hVyQUwaKXyqZ9kPRc",
    projectId: "zebratagpro",
    databaseURL: "https://zebratagpro-default-rtdb.firebaseio.com/"
};
const RESET_TAG       = "SHP RR01";
const SCAN_PREFIX     = "SHP MD01";
const SCAN_DEBOUNCE_MS = 100;

// ─────────────────────────────────────────────────────────────────────────────
// LOGGING
// ─────────────────────────────────────────────────────────────────────────────
function log(message, type = 'info') {
    const logBox = document.getElementById('log-box');
    const time = new Date().toLocaleTimeString();
    const entry = document.createElement('div');
    entry.className = `log-entry ${type}`;
    entry.textContent = `[${time}] ${message}`;
    logBox.insertBefore(entry, logBox.firstChild);
    console.log(`[${type.toUpperCase()}] ${message}`);
    
    // Limit log entries
    while (logBox.children.length > 50) {
        logBox.removeChild(logBox.lastChild);
    }
}

function clearLog() {
    document.getElementById('log-box').innerHTML = '<div class="log-entry info">Log cleared.</div>';
}

// ─────────────────────────────────────────────────────────────────────────────
// FIREBASE
// ─────────────────────────────────────────────────────────────────────────────
firebase.initializeApp(FIREBASE_CONFIG);
const db   = firebase.database();
const auth = firebase.auth();

log('Firebase initialized');

// ─────────────────────────────────────────────────────────────────────────────
// STATUS UPDATES
// ─────────────────────────────────────────────────────────────────────────────
function updateStatus(id, text, active = false) {
    const el = document.getElementById(id);
    el.querySelector('.status-value').textContent = text;
    if (active) {
        el.classList.add('active');
    } else {
        el.classList.remove('active');
    }
}

// ─────────────────────────────────────────────────────────────────────────────
// SCANNER LOGIC
// ─────────────────────────────────────────────────────────────────────────────
const scannerEl = document.getElementById('scanner');
let scanTimer = null;
let scanCount = 0;

function processScan(raw) {
    const val = raw.toUpperCase().trim();
    scanCount++;
    
    log(`Raw input received: "${raw}"`, 'info');
    log(`Processed value: "${val}"`, 'info');
    
    updateStatus('scan-status', val || 'EMPTY');
    
    if (!val) {
        log('Empty value - ignoring', 'error');
        return;
    }
    
    if (val === RESET_TAG) {
        log('✓ RESET TAG DETECTED!', 'success');
        if (auth.currentUser) {
            db.ref('global_scores').set(null)
                .then(() => log('Database reset successful', 'success'))
                .catch(e => log('Database reset failed: ' + e.message, 'error'));
        } else {
            log('Cannot reset - user not authenticated', 'error');
        }
    } else if (val.startsWith(SCAN_PREFIX)) {
        log('✓ SCORE TAG DETECTED!', 'success');
        if (auth.currentUser) {
            db.ref(`global_scores/${auth.currentUser.uid}`).transaction(v => (v || 0) + 1)
                .then(() => log('Score incremented successfully', 'success'))
                .catch(e => log('Score increment failed: ' + e.message, 'error'));
        } else {
            log('Cannot score - user not authenticated', 'error');
        }
    } else {
        log(`✗ Unrecognized tag: "${val}"`, 'error');
        log(`Expected: "${RESET_TAG}" or starts with "${SCAN_PREFIX}"`, 'info');
    }
}

function flushScan() {
    const value = scannerEl.value;
    log(`Flushing buffer: "${value}"`, 'info');
    if (value.trim()) {
        processScan(value);
    }
    scannerEl.value = '';
}

// Event listeners
scannerEl.addEventListener('focus', () => {
    log('Scanner input gained focus', 'info');
    updateStatus('focus-status', 'FOCUSED', true);
});

scannerEl.addEventListener('blur', () => {
    log('Scanner input lost focus', 'info');
    updateStatus('focus-status', 'BLURRED', false);
});

scannerEl.addEventListener('input', (e) => {
    const currentValue = e.target.value;
    log(`Input event: "${currentValue}" (length: ${currentValue.length})`, 'info');
    clearTimeout(scanTimer);
    scanTimer = setTimeout(flushScan, SCAN_DEBOUNCE_MS);
});

scannerEl.addEventListener('keydown', (e) => {
    log(`Keydown: ${e.key} (code: ${e.code})`, 'info');
    if (e.key === 'Enter' || e.key === 'Tab') {
        e.preventDefault();
        log(`${e.key} key detected - flushing immediately`, 'success');
        clearTimeout(scanTimer);
        flushScan();
    }
});

scannerEl.addEventListener('keypress', (e) => {
    log(`Keypress: ${e.key} (charCode: ${e.charCode})`, 'info');
});

// Manual test function
function manualTest() {
    const input = document.getElementById('manual-input');
    const value = input.value;
    log('=== MANUAL TEST ===', 'info');
    processScan(value);
    input.value = '';
}

// Allow Enter key in manual input
document.getElementById('manual-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        manualTest();
    }
});

// ─────────────────────────────────────────────────────────────────────────────
// AUTH
// ─────────────────────────────────────────────────────────────────────────────
auth.onAuthStateChanged(user => {
    if (user) {
        updateStatus('auth-status', user.email, true);
        log('User authenticated: ' + user.email, 'success');
    } else {
        updateStatus('auth-status', 'NOT LOGGED IN', false);
        log('No user authenticated - using anonymous mode', 'error');
        // Sign in anonymously for testing
        auth.signInAnonymously()
            .then(() => log('Signed in anonymously', 'success'))
            .catch(e => log('Anonymous auth failed: ' + e.message, 'error'));
    }
});

// ─────────────────────────────────────────────────────────────────────────────
// FIREBASE CONNECTION
// ─────────────────────────────────────────────────────────────────────────────
db.ref('.info/connected').on('value', s => {
    const online = s.val() === true;
    updateStatus('firebase-status', online ? 'CONNECTED' : 'DISCONNECTED', online);
    log('Firebase connection: ' + (online ? 'ONLINE' : 'OFFLINE'), online ? 'success' : 'error');
});

// ─────────────────────────────────────────────────────────────────────────────
// INITIALIZATION
// ─────────────────────────────────────────────────────────────────────────────
window.addEventListener('load', () => {
    log('Page loaded - focusing scanner input', 'success');
    scannerEl.focus();
    
    // Log DataWedge configuration hints
    log('=== DATAWEDGE CONFIGURATION HINTS ===', 'info');
    log('1. Profile: Check DataWedge profile is enabled', 'info');
    log('2. Output: Should be "Keystroke output"', 'info');
    log('3. Action key: Try "None", "Enter", or "Tab"', 'info');
    log('4. Multi-byte: Disabled recommended', 'info');
    log('5. Focus: This page should have browser focus', 'info');
});

// Keep focus on scanner input
setInterval(() => {
    if (document.activeElement !== scannerEl && 
        document.activeElement.tagName !== 'INPUT' &&
        document.activeElement.tagName !== 'BUTTON') {
        scannerEl.focus();
    }
}, 500);

log('Diagnostic mode ready. Scan a barcode or use manual test.', 'success');
</script>

</body>
</html>