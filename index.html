<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZEBRA TAG - Intent Test</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #050505;
            color: #00ff41;
            font-family: 'Share Tech Mono', monospace;
            padding: 20px;
        }
        .status {
            background: #0d0d0d;
            border: 1px solid #00ff41;
            padding: 20px;
            margin-bottom: 20px;
        }
        .status h2 {
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        .status p {
            font-size: 0.9rem;
            line-height: 1.6;
            margin: 5px 0;
        }
        .btn {
            background: #00ff41;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 10px 10px 0;
            font-size: 1rem;
        }
        .log {
            background: #000;
            border: 1px solid #00ff41;
            padding: 15px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.85rem;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #00ff41;
            padding-left: 10px;
        }
        .error { color: #ff3c3c; border-left-color: #ff3c3c; }
        .success { color: #00ff41; }
        input {
            width: 100%;
            background: #000;
            border: 2px solid #00ff41;
            color: #00ff41;
            padding: 10px;
            font-family: inherit;
            margin: 10px 0;
        }
    </style>
</head>
<body>

<div class="status">
    <h2>ZEBRA DATAWEDGE TEST</h2>
    <p>Scanner Method: <span id="method">Checking...</span></p>
    <p>Last Scan: <span id="last-scan">None</span></p>
    <p>Scan Count: <span id="scan-count">0</span></p>
</div>

<div class="status">
    <h2>MANUAL ENTRY (for testing)</h2>
    <input type="text" id="manual-input" placeholder="Type SHPMD01 or SHPRR01 then press Enter">
</div>

<button class="btn" onclick="testKeystroke()">Test Keystroke Mode</button>
<button class="btn" onclick="testIntent()">Test Intent Mode</button>
<button class="btn" onclick="clearLog()">Clear Log</button>

<div class="log" id="log"></div>

<!-- Hidden scanner for keystroke mode -->

<input type="text" id="scanner" style="position:absolute;left:-9999px;" autocomplete="off">

<script>
const FIREBASE_CONFIG = {
    apiKey: "AIzaSyDFIuHkzGlTNn20-2hVyQUwaKXyqZ9kPRc",
    projectId: "zebratagpro",
    databaseURL: "https://zebratagpro-default-rtdb.firebaseio.com/"
};
const RESET_TAG = "SHPRR01";
const SCORE_TAG = "SHPMD01";

firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.database();
const auth = firebase.auth();

// Sign in anonymously for testing
auth.signInAnonymously();

let scanCount = 0;
let testingKeystroke = false;
let testingIntent = false;

function log(msg, isError = false) {
    const logDiv = document.getElementById('log');
    const entry = document.createElement('div');
    entry.className = 'log-entry ' + (isError ? 'error' : 'success');
    const time = new Date().toLocaleTimeString();
    entry.textContent = `[${time}] ${msg}`;
    logDiv.insertBefore(entry, logDiv.firstChild);
    console.log(msg);
}

function clearLog() {
    document.getElementById('log').innerHTML = '';
}

function processScan(data) {
    scanCount++;
    document.getElementById('scan-count').textContent = scanCount;
    document.getElementById('last-scan').textContent = data;
    
    log('Scan received: ' + data);
    
    const val = data.toUpperCase().trim();
    
    if (val === RESET_TAG) {
        log('RESET TAG detected!');
        alert('RESET TAG: ' + val);
    } else if (val.includes('SHP') && val.includes('MD')) {
        log('SCORE TAG detected!');
        alert('SCORE TAG: ' + val);
    } else {
        log('Unknown tag: ' + val, true);
    }
}

// ============================================
// METHOD 1: KEYSTROKE (what we've been using)
// ============================================
const scannerEl = document.getElementById('scanner');
let scanTimer = null;

function flushKeystrokeScan() {
    const value = scannerEl.value.trim();
    if (value) {
        log('Keystroke scan: ' + value);
        processScan(value);
    }
    scannerEl.value = '';
}

scannerEl.addEventListener('input', () => {
    if (!testingKeystroke) return;
    clearTimeout(scanTimer);
    scanTimer = setTimeout(flushKeystrokeScan, 100);
});

scannerEl.addEventListener('keydown', e => {
    if (!testingKeystroke) return;
    if (e.key === 'Enter' || e.key === 'Tab') {
        e.preventDefault();
        clearTimeout(scanTimer);
        flushKeystrokeScan();
    }
});

function keepScannerFocused() {
    if (testingKeystroke && document.activeElement !== scannerEl) {
        scannerEl.focus();
    }
}

function testKeystroke() {
    testingKeystroke = true;
    testingIntent = false;
    document.getElementById('method').textContent = 'Keystroke Mode (Active)';
    log('Keystroke mode activated - scanner input should now be focused');
    setInterval(keepScannerFocused, 200);
    scannerEl.focus();
}

// ============================================
// METHOD 2: INTENT (alternative method)
// ============================================
function testIntent() {
    testingIntent = true;
    testingKeystroke = false;
    document.getElementById('method').textContent = 'Intent Mode (Active)';
    log('Intent mode activated - DataWedge should broadcast to this page');
    
    // Register for DataWedge intent broadcasts
    if ('BarcodeScanner' in window) {
        log('BarcodeScanner API detected!');
        window.BarcodeScanner.on('scan', (data) => {
            log('Intent scan received via BarcodeScanner API');
            processScan(data.barcode || data.text || data);
        });
    } else {
        log('BarcodeScanner API not found', true);
        log('Try configuring DataWedge to use Intent output with action: com.symbol.datawedge.api.ACTION', true);
    }
}

// ============================================
// MANUAL TESTING
// ============================================
document.getElementById('manual-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        const val = e.target.value;
        log('Manual entry: ' + val);
        processScan(val);
        e.target.value = '';
    }
});

// ============================================
// INITIALIZATION
// ============================================
window.addEventListener('load', () => {
    log('Page loaded. Click "Test Keystroke Mode" then try scanning.');
    log('Or use manual entry field to test the logic.');
    log('');
    log('DATAWEDGE CONFIGURATION NEEDED:');
    log('1. Open DataWedge app');
    log('2. Create/edit profile for Chrome/Browser');
    log('3. Enable "Keystroke output"');
    log('4. Set "Action key" to "Enter" or "Tab"');
    log('5. Associate with Chrome app');
});
</script>

</body>
</html>